# 医院挂号系统数据导入项目 - 完整交付文档

## 📋 项目概述

本项目从Excel挂号信息文件中提取数据，生成适用于PostgreSQL 17数据库的CSV数据文件和PL/pgSQL导入脚本。

## 📦 交付文件清单

### 一、CSV数据文件（3个）

#### 1. department.csv
**描述**: 医院科室层级数据  
**记录数**: 22条  
**结构**: 
```
id,name,father_ID
DEP001,内科,
DEP002,外科,
...
DEP005,心内科门诊,DEP001
```

**内容说明**:
- 4个父科室：内科、外科、妇产科、儿科
- 18个子科室：包括心内科门诊、骨科门诊、妇科门诊等

#### 2. title_number_source.csv
**描述**: 医生职称号源配置  
**记录数**: 4条  
**结构**:
```
id,name,number_source_count,ori_cost
TITLE001,主任医师,30,200.0
TITLE002,副主任医师,50,100.0
TITLE003,主治医师,80,50.0
TITLE004,住院医师,100,20.0
```

**职称说明**:
- TITLE001: 主任医师（30个号源/天，挂号费200元）
- TITLE002: 副主任医师（50个号源/天，挂号费100元）
- TITLE003: 主治医师（80个号源/天，挂号费50元）
- TITLE004: 住院医师（100个号源/天，挂号费20元）

#### 3. doctor_info.csv
**描述**: 医生详细信息  
**记录数**: 369条  
**结构**:
```
doctor_id,doctor_name,title_id,department_name,department_id
DOC0001,丁荣晶,TITLE004,心内科门诊,DEP005
DOC0002,丛杨,TITLE004,感染内科门诊,DEP008
...
```

**职称分配统计** (基于医生稀有程度):
- 主任医师: 18人 (4.9%) - 出诊频率最低
- 副主任医师: 55人 (14.9%)
- 主治医师: 110人 (29.8%)
- 住院医师: 186人 (50.4%) - 出诊频率最高

**科室分布** (前5名):
1. 基本外科门诊: 59人
2. 眼科门诊: 53人
3. 骨科门诊: 43人
4. 泌尿外科门诊: 38人
5. 心内科门诊: 31人

### 二、PL/pgSQL导入脚本（2个）

#### 1. import_data.sql
**描述**: 固定路径导入脚本（适合快速测试）  
**特点**:
- CSV路径写在脚本中：`/mnt/user-data/outputs/`
- 一键执行，无需配置
- 包含完整的导入逻辑和数据验证

**使用方法**:
```bash
psql -U postgres -d hospital_db -f import_data.sql
```

#### 2. import_data_config.sql （推荐使用）
**描述**: 可配置路径的导入脚本  
**特点**:
- 可自定义CSV文件路径
- 提供可重用的导入函数
- 包含完整的统计和验证功能
- 支持重复执行（幂等性）

**使用方法**:
```bash
# 方法1: 修改脚本中的路径变量
# 编辑文件，修改这三行：
# \set department_csv_path '/your/path/department.csv'
# \set title_csv_path '/your/path/title_number_source.csv'
# \set doctor_csv_path '/your/path/doctor_info.csv'

psql -U postgres -d hospital_db -f import_data_config.sql

# 方法2: 使用命令行参数
psql -U postgres -d hospital_db \
  -v department_csv_path="'/path/to/department.csv'" \
  -v title_csv_path="'/path/to/title_number_source.csv'" \
  -v doctor_csv_path="'/path/to/doctor_info.csv'" \
  -f import_data_config.sql
```

**提供的函数**:
- `import_department_data(csv_path)` - 导入科室数据
- `import_title_data(csv_path)` - 导入职称数据
- `import_doctor_data(csv_path)` - 导入医生数据
- `show_import_statistics()` - 显示导入统计

### 三、辅助文档（2个）

#### 1. README_导入说明.md
**描述**: 完整的使用说明文档  
**内容包括**:
- 文件清单和说明
- 详细的使用方法
- 数据结构说明
- 验证查询示例
- 故障排除指南

#### 2. sample_queries.sql
**描述**: 示例查询脚本  
**包含8大类查询**:
1. 数据统计查询
2. 医生信息查询
3. 科室结构查询
4. 职称号源配置查询
5. 用户信息查询
6. 数据完整性检查
7. 高级分析查询
8. 导出查询示例

## 🔄 数据导入流程

### 执行顺序
1. department.csv → department表（科室数据）
2. title_number_source.csv → title_number_source表（职称配置）
3. doctor_info.csv → user表 + clinic表 + doctor表（医生数据）

### 自动处理的内容
脚本会自动完成以下操作：

1. **科室导入**: 先导入父科室，再导入子科室，保证外键完整性
2. **诊室创建**: 为每个科室自动创建对应的诊室
3. **用户生成**: 为每个医生创建用户账号
4. **数据关联**: 自动建立医生、用户、诊室、科室、职称之间的关联

### 自动生成的信息

对于每个医生，系统会自动生成：
- **邮箱**: `{doctor_id}@hospital.com` (如: DOC0001@hospital.com)
- **账号**: `doc_{doctor_id}` (如: doc_DOC0001)
- **密码**: MD5加密的 `{doctor_id}password`
- **手机号**: 随机生成的138开头的11位号码

## 📊 数据统计

### 导入后的数据规模

| 表名 | 记录数 | 说明 |
|------|--------|------|
| department | 22 | 4个父科室 + 18个子科室 |
| clinic | 18 | 每个子科室一个诊室 |
| title_number_source | 4 | 4个职称等级 |
| user | 369 | 所有医生用户 |
| doctor | 369 | 所有医生信息 |

### 医生职称分布

| 职称 | 人数 | 占比 | 挂号费 | 日号源 |
|------|------|------|--------|--------|
| 主任医师 | 18 | 4.9% | ¥200 | 30 |
| 副主任医师 | 55 | 14.9% | ¥100 | 50 |
| 主治医师 | 110 | 29.8% | ¥50 | 80 |
| 住院医师 | 186 | 50.4% | ¥20 | 100 |

### 各父科室情况

| 父科室 | 子科室数 | 医生数 | 潜在日收入 |
|--------|----------|--------|------------|
| 外科 | 6 | 210+ | ¥15,000+ |
| 内科 | 5 | 60+ | ¥4,000+ |
| 妇产科 | 5 | 50+ | ¥3,000+ |
| 儿科 | 2 | 50+ | ¥2,500+ |

## 🎯 医生职称分配算法

职称分配基于医生在原始挂号信息中的**出现频率（稀有程度）**：

```
出现频率越低 → 职称越高 → 挂号费越贵
```

**算法逻辑**:
1. 统计每个医生在挂号表中的出现次数
2. 按出现次数从低到高排序
3. 分配职称：
   - 前5%（最稀有）→ 主任医师
   - 接下来15% → 副主任医师
   - 接下来30% → 主治医师
   - 剩余50% → 住院医师

**例如**:
- 只在一个时间段出现的医生 → 主任医师（稀缺专家）
- 在多个时间段频繁出现的医生 → 住院医师（常规坐诊）

## ✅ 数据验证

导入完成后，执行以下查询验证数据：

```sql
-- 查看导入统计
SELECT * FROM show_import_statistics();

-- 查看医生详情（使用自动创建的视图）
SELECT * FROM v_doctor_detail LIMIT 10;

-- 数据完整性检查
SELECT * FROM v_doctor_detail 
WHERE doctor_id IS NULL 
   OR department_name IS NULL 
   OR title_name IS NULL;
```

## 🛠️ 技术特点

1. **幂等性**: 脚本可以重复执行，使用`ON CONFLICT DO UPDATE`处理重复数据
2. **原子性**: 使用`DO $$`块保证导入过程的事务性
3. **完整性**: 自动维护所有外键关系
4. **可追溯**: 提供详细的导入日志和统计信息
5. **可扩展**: 函数化设计，便于二次开发

## 📝 注意事项

### 前置条件
1. PostgreSQL版本 >= 17
2. 已执行数据库schema创建脚本 (`hospital_register_postgresql_17.sql`)
3. CSV文件使用UTF-8编码（带BOM）
4. PostgreSQL进程有权限读取CSV文件路径

### 常见问题

**Q: 编码错误怎么办？**  
A: 确保CSV文件使用UTF-8编码保存，本项目生成的CSV文件已包含BOM。

**Q: 文件路径错误？**  
A: 检查PostgreSQL是否有权限访问该路径，建议将文件放在`/tmp`目录。

**Q: 可以修改默认密码吗？**  
A: 可以，修改`import_data_config.sql`中的密码生成逻辑。

**Q: 如何添加更多医生？**  
A: 直接在`doctor_info.csv`中添加记录，重新执行导入脚本即可。

## 📈 后续扩展建议

1. **患者数据**: 参考医生数据导入方式，创建患者CSV和导入脚本
2. **排班数据**: 基于挂号信息生成医生排班记录
3. **号源管理**: 根据排班自动计算剩余号源
4. **数据清洗**: 添加数据验证和清洗逻辑
5. **性能优化**: 为大数据量导入添加批量处理

## 📞 技术支持

如遇到问题，请检查：
- PostgreSQL日志
- CSV文件格式和编码
- 数据库权限设置
- 外键约束是否满足

建议按照`README_导入说明.md`中的故障排除部分进行诊断。

---

## 🎉 项目完成清单

- ✅ 从Excel提取科室层级结构（4父科室 + 18子科室）
- ✅ 提取369位医生信息
- ✅ 按稀有程度分配医生职称
- ✅ 生成3个CSV数据文件（UTF-8编码）
- ✅ 创建2个PL/pgSQL导入脚本
- ✅ 提供完整的使用文档
- ✅ 提供示例查询脚本
- ✅ 数据验证和统计功能
- ✅ 自动生成用户账号信息
- ✅ 支持重复执行（幂等性）

**项目状态**: ✨ 已完成交付 ✨
