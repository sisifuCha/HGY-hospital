<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.Mapper.DoctorMapper">

    <!-- 完整的医生信息结果映射，包含来自user表和doctor表的字段 -->
    <resultMap id="FullDoctorResultMap" type="com.example.pojo.entity.Doctor">
        <!-- 映射来自doctor表的字段（子类特有字段） -->
        <result column="doc_title_id" property="titleId"/>
        <result column="clinic_id" property="departmentId"/>
        <result column="status" property="doctorStatus"/>
        <result column="details" property="doctorDetails"/>
        <result column="specialty" property="doctorSpecialty"/>

        <!-- 映射来自user表的字段（继承自User基类的字段） -->
        <result column="id" property="userId"/>
        <result column="name" property="userName"/>
        <result column="sex" property="userGender"/>
        <result column="account" property="userAccount"/>
        <result column="email" property="userEmail"/>
        <result column="pass" property="userPassword"/>
        <result column="phone_num" property="userPhone"/>
    </resultMap>

    <!-- 根据医生ID查询完整信息（联表查询） -->
    <select id="selectById" parameterType="string" resultMap="FullDoctorResultMap">
        SELECT
        d.id,
        d.doc_title_id,
        d.clinic_id,
        d.status,
        u.name,
        u.sex,
        u.account,
        u.email,
        u.pass,
        u.phone_num
        FROM
        doctor d
        INNER JOIN
        "user" u ON d.id = u.id
        WHERE
        d.id = #{id}
    </select>

    <!-- 更新医生信息（可能需要同时更新user表） -->
    <update id="updateDoctor" parameterType="com.example.pojo.entity.Doctor">
        <!-- 如果需要同时更新user表的基本信息，需要先更新user表 -->
        UPDATE "user"
        SET name = #{userName},
        sex = #{userGender},
        account = #{userAccount},
        email = #{userEmail},
        pass = #{userPassword},
        phone_num = #{userPhone}
        WHERE id = #{userId};

        <!-- 然后更新doctor表特有信息 -->
        UPDATE doctor
        SET doc_title_id = #{titleId},
        clinic_id = #{departmentId},
        status = #{doctorStatus},
        details = #{doctorDetails},
        specialty = #{doctorSpeciality}
        WHERE id = #{userId}
    </update>

    <!-- 检查账号名是否存在 -->
    <select id="checkAccountNameExists" resultType="int">
        SELECT COUNT(*) FROM "user"
        WHERE account = #{accountName}
        AND id != #{userId}
    </select>

    <!-- 新增：查询所有医生的完整信息 -->
    <select id="selectAllFullDoctors" resultMap="FullDoctorResultMap">
        SELECT
        d.id as d_id,
        d.doc_title_id,
        d.clinic_id,
        d.status,
        u.user_id,
        u.user_name,
        u.user_gender,
        u.user_account,
        u.user_email,
        u.user_password,
        u.user_phone
        FROM
        doctor d
        INNER JOIN
        user u ON d.user_id = u.user_id
    </select>

    <!-- 新增：根据条件动态查询医生信息 -->
    <select id="selectDoctorsByCondition" parameterType="map" resultMap="FullDoctorResultMap">
        SELECT
        d.id as d_id,
        d.doc_title_id,
        d.clinic_id,
        d.status,
        u.user_id,
        u.user_name,
        u.user_gender,
        u.user_account,
        u.user_email,
        u.user_password,
        u.user_phone
        FROM
        doctor d
        INNER JOIN
        user u ON d.user_id = u.user_id
        <where>
            <if test="departmentId != null and departmentId != ''">
                AND d.clinic_id = #{departmentId}
            </if>
            <if test="doctorStatus != null and doctorStatus != ''">
                AND d.status = #{doctorStatus}
            </if>
            <if test="userName != null and userName != ''">
                AND u.user_name LIKE CONCAT('%', #{userName}, '%')
            </if>
        </where>
    </select>
</mapper>